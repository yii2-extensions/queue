Драйвер для AWS SQS
=================

Этот драйвер для хранения очереди заданий использует AWS SQS.

В приложении должно быть установлено расширение `aws/aws-sdk-php`.

Пример настройки:

```php
return [
    'bootstrap' => [
        'queue', // Компонент регистрирует собственные консольные команды
    ],
    'components' => [
        'queue' => [
            'class' => \yii\queue\sqs\Queue::class,
            'url' => '<sqs url>',
            'key' => '<key>',
            'secret' => '<secret>',
            'region' => '<region>',
        ],
    ],
];
```

Пример настройки для FIFO очередей:

```php
return [
    'bootstrap' => [
        'queue', // Компонент регистрирует собственные консольные команды
    ],
    'components' => [
        'queue' => [
            'class' => \yii\queue\sqs\Queue::class,
            'url' => '<sqs url>',
            'key' => '<key>',
            'secret' => '<secret>',
            'region' => '<region>',
            'messageGroupId' => '<Group ID>',
        ],
    ],
];
```

Идентификатор группы сообщений требуется SQS для очередей FIFO. Вы можете настроить свои собственные или использовать значение "default".

Идентификатор дедупликации генерируется автоматически, поэтому независимо от того, активировали ли вы дедупликацию на основе содержимого в очереди SQS или нет, этот идентификатор будет использоваться.

Консоль
-------

Для обработки очереди используются консольные команды.

```sh
yii queue/listen [timeout]
```

Команда `listen` запускает обработку очереди в режиме демона. Очередь опрашивается непрерывно.
Если добавляются новые задания, то они сразу же извлекаются и выполняются. `timeout` - время
ожидания задания из очереди перед следующей итерацией. `listen` использует функцию "Long Polling", 
которая удерживает соединение с очередью и прослушивает ее на появление новых сообщений.

**Важно!** Параметр`timeout` для драйвера AWS SQS должен быть в интервале от 0 до 20 секунд.

Способ наиболее эфективен если запускать
команду через [supervisor](worker.md#supervisor) или [systemd](worker.md#systemd).

```sh
yii queue/run
```

Команда `run` в цикле извлекает задания из очереди и выполняет их, пока очередь не опустеет, и
завершает свою работу. Это способ подойдет для обработки очереди заданий через
[cron](worker.md#cron).

Для команд `run` и `listen` доступны следующие опции:

- `--verbose`, `-v`: состояние обработки заданий выводится в консоль.
- `--isolate`: каждое задание выполняется в отдельном дочернем процессе.
- `--color`: подсветка вывода в режиме `--verbose`.


```sh
yii queue/clear
```

Команда `clear` делает полную очистку очереди.
